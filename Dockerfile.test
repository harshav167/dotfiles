FROM debian:bookworm-slim

# Avoid prompts from apt
ENV DEBIAN_FRONTEND=noninteractive

# Install basic requirements
RUN apt-get update && apt-get install -y \
    curl \
    git \
    wget \
    sudo \
    python3 \
    python3-pip \
    nodejs \
    npm \
    zsh \
    tmux \
    vim \
    ripgrep \
    fd-find \
    build-essential \
    ca-certificates \
    locales \
    && rm -rf /var/lib/apt/lists/*

# Set up locale
RUN sed -i -e 's/# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen && \
    locale-gen
ENV LANG=en_US.UTF-8
ENV LANGUAGE=en_US:en
ENV LC_ALL=en_US.UTF-8

# Create test user
RUN useradd -m -s /bin/zsh -G sudo testuser && \
    echo "testuser ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/testuser

# Set up symlinks for fd-find
RUN mkdir -p /usr/local/bin && \
    ln -s $(which fdfind) /usr/local/bin/fd

# Switch to test user
USER testuser
WORKDIR /home/testuser

# Copy test script
COPY --chown=testuser:testuser test_dotfiles.sh /home/testuser/test_dotfiles.sh
RUN chmod +x /home/testuser/test_dotfiles.sh

# Set up environment for test user
RUN mkdir -p ~/.local/bin && \
    ln -s /usr/local/bin/fd ~/.local/bin/fd && \
    echo 'export PATH=$HOME/.local/bin:$PATH' >> ~/.zshrc

# Clone dotfiles repo
RUN git clone https://github.com/harshav167/dotfiles.git ~/dotfiles && \
    mkdir -p ~/.config && \
    mkdir -p ~/.tmux

# Run a shell by default with optional test
CMD if [ "$RUN_TESTS" = "true" ]; then \
    /home/testuser/test_dotfiles.sh; \
    else \
    echo "Start a test by running: ./test_dotfiles.sh"; \
    /bin/zsh; \
    fi 