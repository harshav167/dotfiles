FROM ubuntu:24.10

# Avoid prompts from apt
ENV DEBIAN_FRONTEND=noninteractive

# Install basic requirements
RUN apt-get update && apt-get install -y \
    curl \
    git \
    wget \
    sudo \
    python3 \
    python3-pip \
    zsh \
    build-essential \
    ca-certificates \
    locales \
    && rm -rf /var/lib/apt/lists/*

# Set up locale
RUN locale-gen en_US.UTF-8
ENV LANG=en_US.UTF-8
ENV LANGUAGE=en_US:en
ENV LC_ALL=en_US.UTF-8

# Create test user
RUN useradd -m -s /bin/zsh -G sudo testuser && \
    echo "testuser ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/testuser

# Switch to test user
USER testuser
WORKDIR /home/testuser

# Copy test script
COPY test_dotfiles.sh /home/testuser/test_dotfiles.sh
RUN chmod +x /home/testuser/test_dotfiles.sh

# Install dotfiles
RUN /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/harshav167/dotfiles/main/install.sh)"

# Run a shell by default with optional test
CMD if [ "$RUN_TESTS" = "true" ]; then \
    /home/testuser/test_dotfiles.sh; \
    else \
    echo "Start a test by running: ./test_dotfiles.sh"; \
    /bin/zsh; \
    fi 