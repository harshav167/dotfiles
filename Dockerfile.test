FROM ubuntu:24.10

# Avoid prompts from apt
ENV DEBIAN_FRONTEND=noninteractive

# Install basic requirements
RUN apt-get update && apt-get install -y \
    curl \
    git \
    wget \
    sudo \
    python3 \
    python3-pip \
    python3-venv \
    python3-pynvim \
    nodejs \
    npm \
    zsh \
    tmux \
    neovim \
    ripgrep \
    fd-find \
    build-essential \
    ca-certificates \
    locales \
    && rm -rf /var/lib/apt/lists/*

# Set up locale
RUN locale-gen en_US.UTF-8
ENV LANG=en_US.UTF-8
ENV LANGUAGE=en_US:en
ENV LC_ALL=en_US.UTF-8

# Create test user
RUN useradd -m -s /bin/zsh -G sudo testuser && \
    echo "testuser ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/testuser

# Install rust/cargo
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

# Install neovim npm package
RUN npm install -g neovim

# Install lazygit
RUN LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*') && \
    curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz" && \
    tar xf lazygit.tar.gz lazygit && \
    install lazygit /usr/local/bin && \
    rm lazygit lazygit.tar.gz

# Switch to test user
USER testuser
WORKDIR /home/testuser

# Copy test script
COPY --chown=testuser:testuser test_dotfiles.sh /home/testuser/test_dotfiles.sh
RUN chmod +x /home/testuser/test_dotfiles.sh

# Set up symlinks for fd-find
RUN mkdir -p ~/.local/bin && \
    ln -s $(which fdfind) ~/.local/bin/fd && \
    echo 'export PATH=$HOME/.local/bin:$PATH' >> ~/.zshrc && \
    echo 'export PATH=$HOME/.cargo/bin:$PATH' >> ~/.zshrc

# Clone and set up dotfiles manually instead of using install.sh
RUN git clone https://github.com/harshav167/dotfiles.git ~/dotfiles && \
    mkdir -p ~/.config/lvim && \
    cp -r ~/dotfiles/lvim/* ~/.config/lvim/ && \
    mkdir -p ~/.tmux && \
    cp -r ~/dotfiles/tmux/* ~/.tmux/ && \
    test -f ~/.tmux/tmux.conf || cp ~/dotfiles/tmux/tmux.conf ~/.tmux/

# Install LunarVim
RUN export LV_BRANCH='release-1.4/neovim-0.9' && \
    bash <(curl -s https://raw.githubusercontent.com/LunarVim/LunarVim/release-1.4/neovim-0.9/utils/installer/install.sh) --no-install-dependencies

# Run a shell by default with optional test
CMD if [ "$RUN_TESTS" = "true" ]; then \
    /home/testuser/test_dotfiles.sh; \
    else \
    echo "Start a test by running: ./test_dotfiles.sh"; \
    /bin/zsh; \
    fi 